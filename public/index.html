<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Audiências de Custódia</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .badge {
            cursor: pointer;
        }
    </style>

    
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.7/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
        
    <script>
        // Função para formatar a data no formato 'DD/MM/YYYY'
        function formatDateDDMMYYYY(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Mês começa do 0
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Função para formatar a data no formato 'YYYY-MM-DD' para inputs
        function formatDateYYYYMMDD(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Mês começa do 0
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Variável para armazenar a lista de varas selecionadas
        let varasSelecionadas = [];

        // Função para atualizar as datas da última e próxima consulta
        // function atualizarDatasConsulta() {
        //     fetch('/api/datas-consulta') // Ajuste o endpoint da API conforme necessário
        //         .then(response => response.json())
        //         .then(data => {
        //             document.getElementById('ultimaConsulta').textContent = `Última consulta: ${data.ultimaConsulta || ''}`;
        //             document.getElementById('proximaConsulta').textContent = `Próxima consulta: ${data.proximaConsulta || '-'}`;
        //         })
        //         .catch(error => {
        //             console.error('Erro ao carregar datas de consulta:', error);
        //             // document.getElementById('ultimaConsulta').textContent = 'Última consulta: -';
        //             // document.getElementById('proximaConsulta').textContent = 'Próxima consulta: -';
        //         });
        // }

        async function atualizarStatus() {
            try {
                const response = await fetch('/api/datas-consulta');
                const data = await response.json();

                console.log(response);
                let abc = document.getElementById('statusExecucao').textContent = data.status;
                console.log(abc);

                document.getElementById('ultimaConsulta').textContent = `Última consulta: ${data.ultimaConsulta}`;
                document.getElementById('proximaConsulta').textContent = `Próxima consulta: ${data.proximaConsulta}`;
            } catch (error) {
                console.error('Erro ao obter status de consulta:', error);
            }
        }
        // check status a cada 5 segundos
        setInterval(atualizarStatus, 5000);        

        window.onload = () => {
            
            // Limpa as datas ao carregar a página
            document.getElementById('ultimaConsulta').textContent = 'Última consulta: -';
            document.getElementById('proximaConsulta').textContent = 'Próxima consulta: -';

            // Atualiza as datas da última e próxima consulta
            // atualizarDatasConsulta();

            // Obtém os elementos de input
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const startDateLabel = document.getElementById('startDateLabel');
            const endDateLabel = document.getElementById('endDateLabel');

            // Define as datas padrão
            const today = new Date();
            const tomorrow = new Date();
            tomorrow.setDate(today.getDate() + 1);

            // Define os valores dos inputs
            startDateInput.value = formatDateYYYYMMDD(today);
            endDateInput.value = formatDateYYYYMMDD(tomorrow);

            // Exibe as datas no formato DD/MM/YYYY em labels
            startDateLabel.textContent = formatDateDDMMYYYY(today);
            endDateLabel.textContent = formatDateDDMMYYYY(tomorrow);
        };

    </script>
</head>
<body>
    <div class="container mt-4">
        <!-- 1ª Linha: Campo de Texto -->
        <div class="row mb-3">
            <div class="col">
                <h1>Consulta de audiências de custódia</h1>
            </div>
        </div>

        <!-- 2ª Linha: Data Início, Data Fim, Dropdown -->
        <div class="row mb-3 align-items-end">
            <div class="col-md-2">
                <div class="mb-3">
                    <label for="startDate" class="form-label">Data Início</label>
                    <input type="date" id="startDate" name="startDate" class="form-control" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Data Início">
                    <!-- <div id="startDateLabel" class="form-text">Data padrão: DD/MM/YYYY</div> -->
                </div>
            </div>
            <div class="col-md-2">
                <div class="mb-3">
                    <label for="endDate" class="form-label">Data Fim</label>
                    <input type="date" id="endDate" name="endDate" class="form-control" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Data fim">
                    <!-- <div id="endDateLabel" class="form-text">Data padrão: DD/MM/YYYY</div> -->
                </div>
            </div>
            <div class="col-md-7">
                <div class="mb-3">
                    <label for="dropdown" class="form-label">Vara</label>
                    <select class="form-select" id="dropdown" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Selecione e clique em + para adicionar na pesquisa">
                        <!-- Opções serão adicionadas aqui -->
                    </select>
                </div>
            </div>
            <div class="col-md-1">
                <label for="dropdown" class="form-label"></label>
                <div class="mb-3">
                    <button type="button" class="btn btn-secondary" id="adicionarVaras" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Adicionar vara">+</button>
                </div>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col">
                <h1>Varas Selecionadas</h1>
                <div id="listaVaras" class="list-unstyled">
                    <!-- Varas selecionadas aparecerão aqui -->
                </div>
            </div>
        </div>

        <!-- 4ª Linha: Lista de Varas Selecionadas -->
        <!-- <div class="row mb-12">
            <div class="row">
                <h4>Varas Selecionadas</h4>
                <span id="listaVaras" class="list-unstyled">
                </span>
            </div>
        </div> -->

        <!-- 5ª Linha: Label com Consulta Atual -->
        <!-- <div class="row mb-3">
            <div class="col">
                <label id="consultaAtual" class="form-label">Consultando: Nenhuma vara selecionada</label>
            </div>
        </div> -->

        <!-- 6ª Linha: Labels Última e Próxima Consulta -->
        <div class="row mb-3">
            <div class="col">
                <span id="ultimaConsulta">Última consulta: </span> - 
                <span id="proximaConsulta">Próxima consulta: </span>
                <div id="statusExecucao"></div>
            </div>
        </div>

        <!-- 7ª Linha: Botão Iniciar Consulta -->
        <div class="row mb-3">
            <div class="col">
                <button type="button" class="btn btn-primary" id="iniciarConsulta">Iniciar Consulta</button>
            </div>
        </div>

        <!-- 8ª Linha: Tabela de Resultados -->
        <div class="row mb-3">
            <div class="col">
                <table class="table" id="resultados" style="display: none;">
                    <thead>
                        <tr>
                            <th scope="col">Data/Hora</th>
                            <th scope="col">Processo</th>
                            <th scope="col">Juízo/Competência</th>
                            <th scope="col">Sala</th>
                            <th scope="col">Evento/Observação</th>
                            <th scope="col">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Resultados serão adicionados aqui -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 9ª Linha: Container de Aviso -->
        <div class="row">
            <div class="col">
                <div class="alert" role="alert" id="aviso">
                    <!-- Mensagem de aviso aparecerá aqui -->
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts do Bootstrap -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        
        document.addEventListener('DOMContentLoaded', async () => {
            // Atualiza as datas da última e próxima consulta
            try {
            const response = await fetch('/api/datas-consulta');
            if (!response.ok) {
                throw new Error('Erro ao buscar dados da consulta');
            }

            const data = await response.json();
            console.log('Dados da consulta recebidos:', data);

            document.getElementById('ultimaConsulta').textContent = `Última consulta: ${data.ultimaConsulta}`;
            document.getElementById('proximaConsulta').textContent = `Próxima consulta: ${data.proximaConsulta}`;
        } catch (error) {
            console.error('Erro ao carregar datas de consulta:', error);
            document.getElementById('ultimaConsulta').textContent = 'Última consulta: Erro ao carregar';
            document.getElementById('proximaConsulta').textContent = 'Próxima consulta: Erro ao carregar';
        }

            // Código existente para carregar varas disponíveis
            try {
                const response = await fetch('/api/varas');
                const varasDisponiveis = await response.json();
                const dropdown = document.getElementById('dropdown');
                varasDisponiveis.forEach(group => {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = group.label;
                    group.options.forEach(option => {
                        const opt = document.createElement('option');
                        opt.value = option.value;
                        opt.textContent = option.text;
                        if (option.selected) {
                            opt.selected = true;
                            varasSelecionadas.push({ value: option.value, text: option.text });
                        }
                        optgroup.appendChild(opt);
                    });
                    dropdown.appendChild(optgroup);
                });

                // Atualiza a lista de varas selecionadas no DOM
                const listaVaras = document.getElementById('listaVaras');
                listaVaras.innerHTML = ''; // Limpa a lista existente

                varasSelecionadas.forEach(vara => {
                    const span = document.createElement('span');
                    span.textContent = vara.text;
                    span.dataset.value = vara.value;
                    span.classList.add('badge', 'bg-secondary', 'me-1', 'mb-1');
                    span.dataset.bsToggle = 'tooltip';
                    span.dataset.bsPlacement = 'bottom';
                    span.title = 'Clique para remover';
                    listaVaras.appendChild(span);
                    new bootstrap.Tooltip(span);
                });

            } catch (error) {
                console.error('Erro ao carregar varas disponíveis:', error);
                document.getElementById('aviso').textContent = 'Erro ao carregar varas disponíveis.';
            }
        });


        document.getElementById('adicionarVaras').addEventListener('click', () => {
            const dropdown = document.getElementById('dropdown');
            const selectedOption = dropdown.options[dropdown.selectedIndex];
            const valor = selectedOption.value;
            const texto = selectedOption.textContent;

            // Adiciona a vara selecionada na lista, se não já estiver presente
            if (!varasSelecionadas.some(vara => vara.value === valor)) {
                varasSelecionadas.push({ value: valor, text: texto });

                const listaVaras = document.getElementById('listaVaras');
                const span = document.createElement('span');
                span.textContent = texto;
                span.dataset.value = valor; // Armazena o valor da vara no item da lista
                span.classList.add('badge', 'bg-secondary', 'me-1', 'mb-1');
                span.title = 'Clique para remover'; // Tooltip ao passar o mouse
                listaVaras.appendChild(span);
            } else {
                alert(`A ${texto} já está presente na lista.`);
            }
        });

        document.getElementById('listaVaras').addEventListener('click', event => {
            if (event.target.classList.contains('badge')) {
                // Oculta o tooltip ao clicar no badge
                const tooltip = bootstrap.Tooltip.getInstance(event.target);
                if (tooltip) tooltip.hide();

                const valor = event.target.dataset.value;
                varasSelecionadas = varasSelecionadas.filter(vara => vara.value !== valor);
                event.target.remove();
            }
        });

        //import { getUltimaConsulta, getProximaConsulta } from './dadosConsulta.mjs';
        document.getElementById('iniciarConsulta').addEventListener('click', async () => {
            // Desabilita o botão enquanto a consulta está em andamento
            const botaoIniciarConsulta = document.getElementById('iniciarConsulta');
            botaoIniciarConsulta.disabled = true;

            const dataInicio = document.getElementById('startDate').value;
            const dataFim = document.getElementById('endDate').value;
            const varas = varasSelecionadas.map(v => v.value);

            console.log('Dados enviados:', { dataInicio, dataFim, varas });

            try {
                const response = await fetch(`/api/consultar?dataInicio=${encodeURIComponent(dataInicio)}&dataFim=${encodeURIComponent(dataFim)}&varas=${encodeURIComponent(varas.join(','))}`);
                
                if (!response.ok) {
                    throw new Error('Erro na requisição');
                }

                const resultados = await response.json();
                console.log('Resultados recebidos:', resultados);

                const tabela = document.getElementById('resultados');
                const tbody = tabela.querySelector('tbody');
                tbody.innerHTML = ''; // Limpa a tabela

                if (resultados.length === 0) {
                    tabela.style.display = 'none'; // Oculta a tabela
                    const aviso = document.getElementById('aviso');
                    aviso.className = 'alert alert-warning'; // Adiciona a classe de erro
                    aviso.textContent = 'Nenhum resultado encontrado.';
                    return;
                } else {
                    tabela.style.display = 'table'; // Garante que a tabela esteja visível
                }

                resultados.forEach(resultado => {
                    if (resultado.dados === 'Nenhum resultado encontrado.') {
                        const tr = document.createElement('tr');
                        const td = document.createElement('td');
                        td.colSpan = 6;
                        td.textContent = `Vara ${resultado.vara}: Nenhum resultado encontrado.`;
                        tr.appendChild(td);
                        tbody.appendChild(tr);
                    } else {
                        resultado.dados.forEach(row => {
                            const tr = document.createElement('tr');
                            row.forEach(cell => {
                                const td = document.createElement('td');
                                td.textContent = cell;
                                tr.appendChild(td);
                            });

                            const copyButton = document.createElement('button');
                            copyButton.className = 'btn btn-secondary btn-sm';
                            copyButton.innerHTML = '<i class="bi bi-copy"></i>'; // Ícone de copiar

                            copyButton.addEventListener('click', () => {
                                const dadosParaCopiar = [row[4], row[1], row[2], row[0], row[3]]; // Ajuste a ordem se necessário
                                const textoParaCopiar = dadosParaCopiar.join(' - ');

                                navigator.clipboard.writeText(textoParaCopiar).then(() => {
                                    alert('Dados copiados para a área de transferência!');
                                }).catch(err => {
                                    console.error('Erro ao copiar os dados:', err);
                                });
                            });

                            const tdAcoes = document.createElement('td');
                            tdAcoes.appendChild(copyButton);
                            tr.appendChild(tdAcoes);

                            tbody.appendChild(tr);
                        });
                    }
                });

                // Atualiza o aviso para mostrar sucesso
                const aviso = document.getElementById('aviso');
                aviso.className = 'alert alert-success'; // Adiciona a classe de sucesso
                aviso.textContent = 'Consulta realizada com sucesso!';

                document.getElementById('aviso').textContent = 'Consulta realizada com sucesso!';

            } catch (error) {
                console.error('Erro ao consultar:', error);
                // Atualiza o aviso para mostrar erro
                const aviso = document.getElementById('aviso');
                aviso.className = 'alert alert-danger'; // Adiciona a classe de erro
                aviso.textContent = 'Erro ao realizar a consulta.';
            } finally {
                // Habilita o botão após a consulta ser finalizada
                botaoIniciarConsulta.disabled = false;
                // atualizarDatasConsulta(); // Atualiza as datas ao final da execução
            }
        });



        // Inicializa os tooltips no DOM
        document.addEventListener('DOMContentLoaded', function () {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });
    </script>
</body>
</html>
