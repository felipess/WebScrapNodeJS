<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Audiências de Custódia</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <script>
        // Função para formatar a data no formato 'DD/MM/YYYY'
        function formatDateDDMMYYYY(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Mês começa do 0
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Função para formatar a data no formato 'YYYY-MM-DD' para inputs
        function formatDateYYYYMMDD(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Mês começa do 0
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Variável para armazenar a lista de varas selecionadas
        let varasSelecionadas = [];

        window.onload = () => {
            // Obtém os elementos de input
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const startDateLabel = document.getElementById('startDateLabel');
            const endDateLabel = document.getElementById('endDateLabel');

            // Define as datas padrão
            const today = new Date();
            const tomorrow = new Date();
            tomorrow.setDate(today.getDate() + 1);

            // Define os valores dos inputs
            startDateInput.value = formatDateYYYYMMDD(today);
            endDateInput.value = formatDateYYYYMMDD(tomorrow);

            // Exibe as datas no formato DD/MM/YYYY em labels
            startDateLabel.textContent = formatDateDDMMYYYY(today);
            endDateLabel.textContent = formatDateDDMMYYYY(tomorrow);
        };
    </script>
</head>
<body>
    <div class="container mt-4">
        <!-- 1ª Linha: Campo de Texto -->
        <div class="row mb-3">
            <div class="col">
                <h1>Consulta de audiências de custódia</h1>
            </div>
        </div>

        <!-- 2ª Linha: Data Início, Data Fim, Dropdown -->
        <div class="row mb-3">
            <div class="col-md-2">
                <div class="mb-3">
                    <label for="startDate" class="form-label">Data Início</label>
                    <input type="date" id="startDate" name="startDate" class="form-control">
                    <!-- <div id="startDateLabel" class="form-text">Data padrão: DD/MM/YYYY</div> -->
                </div>
            </div>
            <div class="col-md-2">
                <div class="mb-3">
                    <label for="endDate" class="form-label">Data Fim</label>
                    <input type="date" id="endDate" name="endDate" class="form-control">
                    <!-- <div id="endDateLabel" class="form-text">Data padrão: DD/MM/YYYY</div> -->
                </div>
            </div>
            <div class="col-md-7">
                <div class="mb-3">
                    <label for="dropdown" class="form-label">Vara</label>
                    <select class="form-select" id="dropdown">
                        <!-- Opções serão adicionadas aqui -->
                    </select>
                </div>
            </div>
            <div class="col-md-1">
                <label for="dropdown" class="form-label">Adicionar</label>
                <div class="mb-3">
                    <button type="button" class="btn btn-secondary" id="adicionarVaras">+</button>
                </div>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col">
                <h1>Varas Selecionadas</h1>
                <div id="listaVaras" class="list-unstyled">
                    <!-- Varas selecionadas aparecerão aqui -->
                </div>
            </div>
        </div>

        <!-- 4ª Linha: Lista de Varas Selecionadas -->
        <!-- <div class="row mb-12">
            <div class="row">
                <h4>Varas Selecionadas</h4>
                <span id="listaVaras" class="list-unstyled">
                </span>
            </div>
        </div> -->

        <!-- 5ª Linha: Label com Consulta Atual -->
        <!-- <div class="row mb-3">
            <div class="col">
                <label id="consultaAtual" class="form-label">Consultando: Nenhuma vara selecionada</label>
            </div>
        </div> -->

        <!-- 6ª Linha: Labels Última e Próxima Consulta -->
        <div class="row mb-3">
            <div class="col">
                <span id="ultimaConsulta">Última consulta: {ultimaconsulta}</span> - 
                <span id="proximaConsulta">Próxima consulta: {proximaconsulta}</span>
            </div>
        </div>

        <!-- 7ª Linha: Botão Iniciar Consulta -->
        <div class="row mb-3">
            <div class="col">
                <button type="button" class="btn btn-primary" id="iniciarConsulta">Iniciar Consulta</button>
            </div>
        </div>

        <!-- 8ª Linha: Tabela de Resultados -->
        <div class="row mb-3">
            <div class="col">
                <table class="table" id="resultados">
                    <thead>
                        <tr>
                            <th scope="col">Data/Hora</th>
                            <th scope="col">Processo</th>
                            <th scope="col">Juízo/Competência</th>
                            <th scope="col">Sala</th>
                            <th scope="col">Evento/Observação</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Resultados serão adicionados aqui -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 9ª Linha: Container de Aviso -->
        <div class="row">
            <div class="col">
                <div class="alert alert-warning" role="alert" id="aviso">
                    <!-- Mensagem de aviso aparecerá aqui -->
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts do Bootstrap -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('/api/varas');
                const varasDisponiveis = await response.json();
                const dropdown = document.getElementById('dropdown');
                varasDisponiveis.forEach(group => {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = group.label;
                    group.options.forEach(option => {
                        const opt = document.createElement('option');
                        opt.value = option.value;
                        opt.textContent = option.text;
                        if (option.selected) {
                            opt.selected = true;
                            // Adiciona as opções pré-selecionadas na lista varasSelecionadas
                            varasSelecionadas.push({ value: option.value, text: option.text });
                        }
                        optgroup.appendChild(opt);
                    });
                    dropdown.appendChild(optgroup);
                });

                // Atualiza a lista de varas selecionadas no DOM
                const listaVaras = document.getElementById('listaVaras');
                varasSelecionadas.forEach(vara => {
                    const li = document.createElement('li');
                    li.textContent = vara.text;
                    li.dataset.value = vara.value; // Armazena o valor da vara no item da lista
                    li.classList.add('list-item');
                    listaVaras.appendChild(li);
                });

                // Atualiza o label 'consultaAtual'
                //document.getElementById('consultaAtual').textContent = `Consultando: ${varasSelecionadas.map(v => v.text).join(', ')}`;


            } catch (error) {
                console.error('Erro ao carregar varas disponíveis:', error);
                document.getElementById('aviso').textContent = 'Erro ao carregar varas disponíveis.';
            }
        });

        document.getElementById('adicionarVaras').addEventListener('click', () => {
            const dropdown = document.getElementById('dropdown');
            const selectedOption = dropdown.options[dropdown.selectedIndex];
            const valor = selectedOption.value;
            const texto = selectedOption.textContent;

            if (valor && !varasSelecionadas.some(v => v.value === valor)) {
                // Adiciona a vara selecionada na lista
                varasSelecionadas.push({ value: valor, text: texto });

                // Atualiza a lista de varas no DOM
                const listaVaras = document.getElementById('listaVaras');
                const li = document.createElement('li');
                li.textContent = texto;
                li.dataset.value = valor; // Armazena o valor da vara no item da lista
                li.classList.add('list-item');
                listaVaras.appendChild(li);

                // Atualiza o label 'consultaAtual'
                //document.getElementById('consultaAtual').textContent = `Consultando: ${varasSelecionadas.map(v => v.text).join(', ')}`;
            }
        });

        document.getElementById('listaVaras').addEventListener('click', (event) => {
            if (event.target.classList.contains('list-item')) {
                const item = event.target;
                const valor = item.dataset.value;
                
                // Remove a vara da lista varasSelecionadas
                varasSelecionadas = varasSelecionadas.filter(v => v.value !== valor);
                
                // Remove o item da listaVaras no DOM
                item.remove();
            }
        });

        document.getElementById('iniciarConsulta').addEventListener('click', async () => {
            const dataInicio = document.getElementById('startDate').value;
            const dataFim = document.getElementById('endDate').value;

            // Converte varasSelecionadas para uma lista de valores separados por vírgula
            const varas = varasSelecionadas.map(v => v.value);

            console.log('Dados enviados:', { dataInicio, dataFim, varas });

            try {
                const response = await fetch(`/api/consultar?dataInicio=${encodeURIComponent(dataInicio)}&dataFim=${encodeURIComponent(dataFim)}&varas=${encodeURIComponent(varas.join(','))}`);
                
                console.log('Resposta da API:', response);

                if (!response.ok) {
                    throw new Error('Erro na requisição');
                }

                const resultados = await response.json();
                console.log('Resultados recebidos:', resultados);

                const tbody = document.querySelector('#resultados tbody');
                tbody.innerHTML = ''; // Limpa a tabela

                resultados.forEach(resultado => {
                    if (resultado.dados === 'Nenhum resultado encontrado.') {
                        const tr = document.createElement('tr');
                        const td = document.createElement('td');
                        td.colSpan = 5;
                        td.textContent = `Vara ${resultado.vara}: Nenhum resultado encontrado.`;
                        tr.appendChild(td);
                        tbody.appendChild(tr);
                    } else {
                        resultado.dados.forEach(row => {
                            const tr = document.createElement('tr');
                            row.forEach(cell => {
                                const td = document.createElement('td');
                                td.textContent = cell;
                                tr.appendChild(td);
                            });
                            tbody.appendChild(tr);
                        });
                    }
                });

                document.getElementById('aviso').textContent = 'Consulta realizada com sucesso!';
            } catch (error) {
                console.error('Erro ao consultar:', error);
                document.getElementById('aviso').textContent = 'Erro ao realizar a consulta.';
            }
        });
    </script>
</body>
</html>
